{"version":3,"sources":["file:///Users/baitengfei/code/EscapeRoom/EscapeRoomMVP/assets/Scripts/SDK/WXAPI.ts"],"names":["_decorator","SingletonClass","Tools","ccclass","property","WXAPI","launchOption","mListAds","ins","wxLogin","func","wx","login","success","res","code","console","log","errMsg","getStorageSync","key","value","e","setStorageSync","removeStorageSync","share","t","images","url","id","desc","randomImageIndex","Random","length","iUrl","query","shareAppMessage","title","imageUrl","imageUrlId","onShowGame","_callback","shareStartTimeSecond","getTimeStamp","_res","isShareSuccess","interval","window","offShow","onShow","callBack","onHide","CheckAccelerometer","onAccelerometerChange","x","y","CreateAd","adUnitId","rewardAd","index","item","offError","offClose","onError","err","onClose","isEnded","undefined","createRewardedVideoAd","multiton","push","ShowAd","show","then","catch","load"],"mappings":"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","sourcesContent":["import SingletonClass from '../Base/SingletonClass';\r\nimport { GameData } from '../Data/GameData';\r\nimport { UIManager, UIType } from '../Manager/UIManager';\r\n\r\nimport { _decorator, Component, log } from 'cc';\r\nimport { Tools } from '../Tool/Tools';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('WXAPI')\r\nexport class WXAPI extends SingletonClass {\r\n    launchOption;\r\n    static ins() {\r\n        return super.ins() as WXAPI;\r\n    }\r\n   \r\n    //微信登录\r\n    static wxLogin(func) {\r\n        wx.login({\r\n            success(res) {\r\n                if (res.code && func) {\r\n                    func(res);\r\n                }\r\n                else {\r\n                    console.log('登录失败！' + res.errMsg);\r\n                }\r\n            }\r\n        })\r\n    }\r\n\r\n    //同步获取缓存数据\r\n    static getStorageSync(key) {\r\n        var value = null;\r\n        try {\r\n            value = wx.getStorageSync(key);\r\n        }\r\n        catch (e) {\r\n            console.log(\"get storage \", key, \":\", e);\r\n        }\r\n        return value;\r\n\r\n    }\r\n    //同步设置缓存数据\r\n    static setStorageSync(key, value) {\r\n        try {\r\n            wx.setStorageSync(key, value);\r\n        }\r\n        catch (e) {\r\n            console.log(\"set storage \", key, \":\", e);\r\n        }\r\n\r\n    }\r\n\r\n    //清除缓存数据\r\n    static removeStorageSync(key) {\r\n        try {\r\n            wx.removeStorageSync(key);\r\n        }\r\n        catch (e) {\r\n            console.log(\"remove storage \", key, \":\", e);\r\n        }\r\n\r\n    }\r\n\r\n    static share() {\r\n        var t = \"成功通关，智能版密室逃脱\";\r\n\r\n        // image\r\n        var images = [\r\n            {\r\n                url:\"https://mmocgame.qpic.cn/wechatgame/kwPxRMtzghTg3YW1outInnP998BV9so9rkxUIZE3gKWffVAEjz4DnulRkJ9d29q2/0\",\r\n                id:\"w4LQEtAhT4aaMyb0e1A7rA==\",\r\n                desc:\"成功通关，智能版密室逃脱\"\r\n            }\r\n        ]\r\n        let randomImageIndex = Tools.Random(0, images.length);\r\n        var iUrl = images[randomImageIndex].url;\r\n        var id = images[randomImageIndex].id;\r\n\r\n        var query = \"userId=1\";\r\n\r\n        wx.shareAppMessage({\r\n            title: t,\r\n            imageUrl: iUrl,\r\n            query: query,\r\n            imageUrlId: id,\r\n        });\r\n    }\r\n\r\n    /**\r\n    * 此方法每次点击分享就执行一次\r\n    * @param _callback处理分享的回调\r\n    */\r\n    static shareStartTimeSecond:number = 0;\r\n    static onShowGame(_callback: any): void {\r\n        console.log(\"---游戏回到前台---------------\");\r\n        // 记录点击分享的时间（秒级）\r\n        this.shareStartTimeSecond = Tools.getTimeStamp();\r\n        let func: Function = (_res: any)=>{\r\n            let isShareSuccess: boolean = false;\r\n            if (this.shareStartTimeSecond <= 0) {\r\n                // 不处理\r\n            }else {\r\n                // 判断转发成功与否，按时间处理\r\n                let interval: number = Tools.getTimeStamp() - this.shareStartTimeSecond;\r\n                this.shareStartTimeSecond = -1;\r\n                // 我这里间隔设置为2.5s\r\n                if (interval >= 2.5) {\r\n                    isShareSuccess = true;\r\n                }\r\n            }\r\n            _callback(isShareSuccess);\r\n            // 取消监听小游戏回到前台的事件\r\n            window['wx'].offShow(func);\r\n        };\r\n        // 监听小游戏回到前台的事件\r\n        window['wx'].onShow(func);\r\n    }\r\n\r\n    static onShow(callBack) {\r\n        if (typeof (callBack) == \"function\") {\r\n            wx.onShow(callBack);\r\n        }\r\n    }\r\n\r\n    static onHide(callBack) {\r\n        if (typeof (callBack) == \"function\") {\r\n            wx.onHide(callBack);\r\n        }\r\n    }\r\n\r\n    CheckAccelerometer(callBack:any) {\r\n        wx.onAccelerometerChange(function(res) {\r\n            if (res.x > 0.8 || res.y > 0.8) {\r\n                // wx.showToast({\r\n                //     title:\"摇晃\",\r\n                //     duration: 2000\r\n                // })\r\n                callBack();\r\n            }\r\n        })\r\n    }\r\n\r\n    mListAds:any[] = [];\r\n    CreateAd(adUnitId, callBack) {\r\n        let rewardAd = null;\r\n        for (let index = 0; index < WXAPI.ins().mListAds.length; index++) {\r\n            let item = WXAPI.ins().mListAds[index];\r\n            if (item.adUnitId == adUnitId) {\r\n                rewardAd = item.rewardAd;\r\n                break;\r\n            }\r\n        }\r\n\r\n        if (rewardAd != null) \r\n        {\r\n            rewardAd.offError();\r\n            rewardAd.offClose();\r\n\r\n            rewardAd.onError(err => {\r\n                console.log(\"创建广告错误：\" , err);\r\n            })\r\n    \r\n            rewardAd.onClose(res => {\r\n                // 用户点击了【关闭广告】按钮\r\n                // 小于 2.1.0 的基础库版本，res 是一个 undefined\r\n                if (res && res.isEnded || res === undefined) {\r\n                    // 正常播放结束，可以下发游戏奖励\r\n                    callBack(true);\r\n                }\r\n                else {\r\n                    // 播放中途退出，不下发游戏奖励\r\n                    callBack(false);\r\n                }\r\n            })\r\n            return;\r\n        }\r\n\r\n        // 创建激励视频广告实例，提前初始化\r\n        rewardAd = wx.createRewardedVideoAd({\r\n            adUnitId: adUnitId,\r\n            multiton: true\r\n        })\r\n\r\n        WXAPI.ins().mListAds.push({adUnitId:adUnitId, rewardAd:rewardAd});\r\n        \r\n        rewardAd.onError(err => {\r\n            console.log(\"创建广告错误：\" , err);\r\n        })\r\n\r\n        rewardAd.onClose(res => {\r\n            // 用户点击了【关闭广告】按钮\r\n            // 小于 2.1.0 的基础库版本，res 是一个 undefined\r\n            if (res && res.isEnded || res === undefined) {\r\n                // 正常播放结束，可以下发游戏奖励\r\n                callBack(true);\r\n            }\r\n            else {\r\n                // 播放中途退出，不下发游戏奖励\r\n                callBack(false);\r\n            }\r\n        })\r\n    }\r\n\r\n    ShowAd(adUnitId) {\r\n        let rewardAd = null;\r\n        for (let index = 0; index < WXAPI.ins().mListAds.length; index++) {\r\n            let item = WXAPI.ins().mListAds[index];\r\n            if (item.adUnitId == adUnitId) {\r\n                rewardAd = item.rewardAd;\r\n                break;\r\n            }\r\n        }\r\n        if (rewardAd == null) {\r\n            return;\r\n        }\r\n\r\n        // 用户触发广告后，显示激励视频广告\r\n        rewardAd.show()\r\n        .then(() => {})\r\n        .catch(() => {\r\n            // 失败重试\r\n            rewardAd.load()\r\n            .then(() => {\r\n                rewardAd.show();\r\n            })\r\n            .catch(err => {\r\n                console.log('激励视频 广告显示失败')\r\n            })\r\n        }) \r\n    }\r\n}\r\n"]}